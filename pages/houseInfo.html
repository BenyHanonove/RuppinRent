<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <link rel="stylesheet" href="../style/style1.css" />

    <script src="../Scripts/ajaxCalls.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous">
    </script>

    <script>

        let houseData;
        let maxDays;
        let minDays;
        let HouseOrders;

        $(document).ready(function () {
            $("#signIn").click(signInHerf);
            $("#signUp").click(signUpHerf);
            $("#logoPic").click(indexHerf);
            activeUser();
            loadHouse();
        });

        function activeUser() {
            if (localStorage.getItem('user') != null) {
                 let active = JSON.parse(localStorage.getItem("user"));
                 let str = "<p>Hello <br>";
                 str += active.Username;
                 str += "</p>";
                 str += '<button id="logOut">LOG OUT</button>'
                 $("#sign").html(str);
                 $("#logOut").click(logOut);
             }
        }

        function logOut() {
            localStorage.clear();
            indexHerf();
        }

        function signInHerf() {
            window.location.href = 'signIn.html';
            localStorage.setItem("house", null);
        }

        function signUpHerf() {
            window.location.href = 'signUp.html';
            localStorage.setItem("house", null);
        }

        function indexHerf() {
            window.location.href = 'index.html';
            localStorage.setItem("house", null);
        }

        function loadHouse() {
            let id = localStorage.getItem("house");
            let newId = Number(id);

            let api = "../api/Houses/" + id ;
            ajaxCall("GET", api, "", getHouseSuccessCB, getHouseErrorCB);

        }

        function getHouseSuccessCB(house) {
            houseData = house;

            maxDays = house.MaximumNights;
            minDays = house.MinimumNights;

            let str = "";
            str += "<div id=left>";
            str += "<h1>Aprtment score:" + house.Score + "★</h1>";
            str += "<img src=" + house.Picture + ">";
            str += "</div>";

            str += "<div id=right>";
            str += "<h1>" + house.Name + "</h1>";
            str += "<p>Description: " + house.Description + "</p><br>";
            str += "<h3>About the Neighbourhoood:</h3>";
            str += "<p>" + house.Neighbourhoood + ":" + house.NeighbourhooodOverview + "</p>";

            if (localStorage.getItem('user') != null) {
                str += "<button onclick='DateChoose()'>Order</button>";
            }
            str += "</div>";

            $("#big").html(str);
            loadReviews(house);
        }

        function getHouseErrorCB(err) {
            console.log(err);
        }


        function loadReviews(house) {
            let id = house.Id;
            let api = "../api/Reviews/"+ id;
            ajaxCall("GET", api, "", getReviewsSuccessCB, getReviewsErrorCB);
        }

        function getReviewsSuccessCB(reviews) {
            buildReviewsLog(reviews);
        }

        function getReviewsErrorCB(err) {
            console.log(err);
        }

        function buildReviewsLog(reviews) {

            let str = "<h3>Reviews:</h3>";

            for (let i = 0; i<reviews.length; i++) {
                str += "<div class='reviews'>";
                str += "<p>" + reviews[i].ReviewerName +" "+ reviews[i].Date+ ":</p>";
                str += "<p>" + reviews[i].Comments + "</p>";
                str += "</div>";
            }

            $("#reviews").html(str);

            let id = houseData.Id;
            let api = "../api/Orders/" + id;
            ajaxCall("GET", api, "", getOrdersSuccessCB, getOrdersErrorCB);

        }

        function getOrdersSuccessCB(orders) {
            HouseOrders = orders;
        }

        function getOrdersErrorCB(err) {
            console.log(err);
        }

        function DateChoose() {
            let str = "";
            str += "<div id=right>";
            str += "<h1>" + houseData.Name + "</h1>";
            str += "<h3>Please Select Dates</h3>";
            str += "<h4>enter start date :<h4>"
            str += "<input type='date' id='order4'>";
            str += "<br>";
            str +="<h4>enter end date :<h4>"
            str += "<input type='date' id='order4end'>";
            str += "<button onclick='BuildOrder()'>Sumit</button>";
            $("#right").html(str);


            str = "<h4>orders for this house:<h4>";
            str += "<table><tr><td>order start</td><td>order end</td></tr>";
            for (let i = 0; i < HouseOrders.length;i++) {

                let date1 = (HouseOrders[i].OrderdFor).split("-");
                for (let i = 0; i < 3; i++) {
                    date1[i] = date1[i].toString();
                }
                date1[2] = date1[2].substring(0, 2);

                date1 = date1[2] + "/" + date1[1] + "/"+ date1[0];

                let date2 = (HouseOrders[i].OrderdOut).split("-");
                for (let i = 0; i < 3; i++) {
                    date2[i] = date2[i].toString();
                }
                date2[2] = date2[2].substring(0, 2);

                date2 = date2[2] + "/" + date2[1] + "/" + date2[0];


                str += "<tr><td>" + date1 + "</td><td>" + date2 + "</td></tr>";


            }

            $("#dates").html(str);
            $("#reviews").html("");
        }

        function BuildOrder() {

       
            let email = JSON.parse(localStorage.getItem("user")).Email;
            let OrderFor = $("#order4").val();
            let OrderEnd = $("#order4end").val()

            let currentDate = new Date();
            let start = dateTransfer(OrderFor);
            let end = dateTransfer(OrderEnd);

            let dateDiff = (end - start) / (1000 * 60 * 60 * 24);
            console.log(dateDiff);

            //arr with all the dates that can't be used
            invaildArr = DatesBtweenOrders();
            userDates = DatesBtweenUser(start, end);


            let dateCheck = false;
            for (let j = 0; j < userDates.length; j++) {

                for (let i = 0; i < invaildArr.length; i++) {

                    if (userDates[j] == invaildArr[i]) {
                        dateCheck == true;
                        break;
                    }
                }
            }

            //check if the days the user put are vaild 
            // and can be orderd
            if (dateCheck == false) {
                if (start > currentDate) {
                    if (dateDiff >0) {
                        if (dateDiff >= minDays) {
                            if (dateDiff <= maxDays) {
                                let orderData = {
                                    Email: email,
                                    houseId: houseData.Id,
                                    orderdIn: currentDate,
                                    orderdFor: OrderFor,
                                    orderdOut: OrderEnd
                                };
                                addOrder(orderData);
                            }
                            else {
                                alert("your order is to long the max days are " + maxDays);
                            }
                        }
                        else {
                            alert("order has to be longer then " + minDays + " days");
                        }
                    }
                    else {
                        alert("end day has to be bigger then start day");
                    }
                }
                else {
                    alert("start date is outdated");
                }
            } else {
                alert("there is order in this date");
            }


        }

        function addOrder(order) {
            let api = "../api/Orders";
            ajaxCall("POST", api, JSON.stringify(order), addOrderSuccessCB, addOrderErrorCB);
        }


        function addOrderSuccessCB(status) {
            alert("your order has been added");
            indexHerf();
        }

        function updateCounter() {
            let active = JSON.parse(localStorage.getItem("user"));
            let Id = active.id;
            let api = "..api/Users/" +Id;
            ajaxCall("PUT", api, "", updateCounterSuccessCB, updateCounterErrorCB);
        }

        function updateCounterSuccessCB() {
            alert("counter has been updated");
        }

        function updateCounterErrorCB(err) {
            console.log(err);
        }

        function addOrderErrorCB(err) {
            console.log(err);
        }


        function DatesBtweenOrders() {
            DatesArr = [];

            for (let i = 0; i < HouseOrders.length; i++) {
                let start = new Date(HouseOrders[i].OrderdFor);
                let end = new Date(HouseOrders[i].OrderdOut);

                while (start <= end) {
                    DatesArr.push(new Date(start));
                    start.setDate(start.getDate()+1)
                }

            }

            return DatesArr;
        }

        function DatesBtweenUser(start,end) {
            DatesArr = [];

            while (start <= end) {
                DatesArr.push(new Date(start));
                start.setDate(start.getDate() + 1)

            }

            return DatesArr;
        }


        function dateTransfer(date) {
            let  newDate= date.split("-");
            for (let i = 0; i < 3; i++) {
                newDate[i] = newDate[i].toString();
            }
            newDate[2] = newDate[2].substring(0, 2);


            let oDate = new Date(newDate[0], newDate[1], newDate[2]);
            return oDate;
        }

        
    </script>


</head>
<body>

    <div id="logo">

        <div id="sign">
            <button id="signIn">sign in</button>
            <button id="signUp">sign up</button>
        </div>

        <img id="logoPic" class="center" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSUtXYroKYwmQyjRYfxOoaqstjf0uSYuuFpaA&usqp=CAU" />
        <h1>Ruppin Rent</h1>
    </div>

    <div id="big">
       
    </div>

    <div id="reviews">

    </div>

    <div id="dates">

    </div>
</body>
</html>