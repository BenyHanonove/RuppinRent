<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <link rel="stylesheet" hrel="../style/indexStyle.css" />
    <link rel="stylesheet" href="../style/style1.css" />
    <link href="../style/cssgrids.css" rel="stylesheet" />

    <script src="../Scripts/ajaxCalls.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous">
    </script>

    <script>

        let orders;
        let counter = 0;

        $(document).ready(function () {
            $("#signIn").click(signInHerf);
            $("#signUp").click(signUpHerf);
            $("#logoPic").click(indexHerf);
            activeUser();
            loadOrders();
        });

        function activeUser() {

            if (localStorage.getItem('user') != null) {
                let active = JSON.parse(localStorage.getItem("user"));
                let str = "<p>Hello <br>";
                str += active.Username;
                str += "</p>";
                str += '<button id="logOut">LOG OUT</button>'
                $("#sign").html(str);
                $("#logOut").click(logOut);
            }
        }

        function logOut() {
            localStorage.clear();
            indexHerf();
        }

        function signInHerf() {
            window.location.href = 'signIn.html';
            localStorage.setItem("house", null);
        }

        function signUpHerf() {
            window.location.href = 'signUp.html';
            localStorage.setItem("house", null);
        }

        function indexHerf() {
            window.location.href = 'index.html';
            localStorage.setItem("house", null);
        }


        function loadOrders() {
            let user = JSON.parse(localStorage.getItem("user"));
            let api = "../api/Orders?Email=" + user.Email;
            ajaxCall("GET", api, "", getOrdersSuccessCB, getOrdersErrorCB);
        }

        function getOrdersErrorCB(err) {
            console.log(err);
        }

        function getOrdersSuccessCB(ordersData) {

            let str1 = "<p><h1>My Orders :</h1></p>";
            $("#big").html(str1);

            orders = ordersData;
            for (let i = 0; i < orders.length; i++) {
                let id = ordersData[i].HouseId;
                let api = "../api/Houses/" + id;
                ajaxCall("GET", api, "", getHouseSuccessCB, getHouseErrorCB);
            }

        }

        function getHouseSuccessCB(houseData) {
            buildPage(houseData, orders[counter]);
        }

        function getHouseErrorCB(err) {
            console.log(err);
        }

        function buildPage(house, order) {

            let orderEnd = order.OrderdOut;
            let datesTillDone = dayGap(orderEnd);
            let orderDate = order.OrderdFor;
            let datesBeforeOrder = dayGap(orderDate);

            let str = "";
            str += "<div class='card'>";
            str += "<div class='box'>";
            str += "<div class='content'>";
            str += "<img class='small'  src=" + house.Picture + " >";
            str += "<p>" + house.Score + "★</p>";
            str += "<p>" + house.Name + "</p>";

            if (datesTillDone < 0) {
                str += "<a href='#' onclick='showReviewLog(" + JSON.stringify(order) + ")'>add review</a>";
            }
            else {
                if (datesBeforeOrder > 2) {
                    str += "<a href='#' onclick='deleteOrder(" + (order.Id).toString() + ")'>cancel</a>";
                }

            }
            str += "</div>";
            str += "</div>";
            str += "</div>";

            if (datesTillDone < 0) {
                let htmlStr = $("#done").html() + str;
                $("#done").html(htmlStr);
            }
            else {
                let htmlStr = $("#wait").html() + str;
                $("#wait").html(htmlStr);
            }

            counter++;
        }

        function deleteOrder(id) {

            let orderData = {
                Email: null,
                houseId: null,
                orderdIn: null,
                orderdFor: null,
                orderdOut: null,
                Id: id
            };

            let api = "../api/Orders/delete";
            ajaxCall("DELETE", api, JSON.stringify(orderData), deleteOrderSuccessCB, deleteOrderErrorCB);
        }

        function deleteOrderSuccessCB() {
            updateDeleteCounter();
        }

        function deleteOrderErrorCB(err) {
            console.log(err);
        }

        function dayGap(orderDate) {

            let date = orderDate.split("-");
            for (let i = 0; i < 3; i++) {
                date[i] = date[i].toString();
            }
            date[2] = date[2].substring(0, 2);


            let oDate = new Date(date[0], date[1], date[2]);
            let currentDate = new Date();

            let diffInDays = Math.round((oDate - currentDate) / (1000 * 60 * 60 * 24));
            return diffInDays;
        }

        function updateDeleteCounter() {
            let user = JSON.parse(localStorage.getItem("user"));

            let userData = {
                email: user.Email,
                password: user.Password,
                username: user.Username,
                joinDate: user.JoinDate,
                rentTotal: user.RentTotal,
                cancelTotal: user.CancelTotal,
                id: user.Id,
                totalIncome: user.TotalIncome
            }
            let api = "../api/Users/Cancel";
            ajaxCall("PUT", api, JSON.stringify(userData), updateCounterSuccessCB, updateCounterErrorCB);

            function updateCounterSuccessCB() {
                alert("order has been removed");
                indexHerf();
            }

            function updateCounterErrorCB(err) {
                console.log(err);
            }
        }


        function showReviewLog(orderData) {

            let upload = JSON.stringify(orderData);
            localStorage.setItem("order", upload);

            $("#done").html("");
            $("#wait").html("");

            let str = "<h4>we hope u enjoyed your house rent with our website !</h4> ";
            str += "<h5>please leave your review:<h5>";
            str += "<input type='text' id='textbox'>";

            str += "<button id='btn'>add review</button>"

            $("#big").html(str);
            $("#btn").click(uploadReview);
        }

        function uploadReview() {
            let text = $("#textbox").val();
            let day = new Date();
            let order = JSON.parse(localStorage.getItem("order"));
            let user = JSON.parse(localStorage.getItem("user"));

            console.log(order);

            let ReviewData = {
                Comments: text,
                Date: null,
                Id: null,
                ListingId: order.HouseId,
                ReviewerId: user.Id,
                ReviewerName: user.Email
            };


            let api = "../api/Reviews";
            ajaxCall("POST", api, JSON.stringify(ReviewData), addReviewSuccessCB, addReviewErrorCB);

        }

        function addReviewSuccessCB() {
            let order = JSON.parse(localStorage.getItem("order"));            
            let orderData = {
                Email: null,
                houseId: null,
                orderdIn: null,
                orderdFor: null,
                orderdOut: null,
                Id: order.Houseid,
            };

            let api = "../api/Orders/delete";
            ajaxCall("DELETE", api, JSON.stringify(orderData), quickDeleteSuccessCB, deleteOrderErrorCB);
        }

        function quickDeleteSuccessCB() {
            indexHerf();
        }

        function addReviewErrorCB(err) {
            console.log(err);
        }

    </script>

</head>
<body>


    <div id="logo">

        <div id="sign">
            <button id="signIn">sign in</button>
            <button id="signUp">sign up</button>
        </div>


        <img id="logoPic" class="center" style="width: 600px; height: 400px;" src="../ruppinLogo/logo.png" />
        <!--<img id="logoPic" class="center" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSUtXYroKYwmQyjRYfxOoaqstjf0uSYuuFpaA&usqp=CAU" />-->

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    </div>


    <div id="big"></div>

    <div id="done" class="container"></div>

    <div id="wait" class="container"></div>

</body>
</html>